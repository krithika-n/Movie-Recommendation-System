import queryexecutioner
import numpy
import lda
import lda.datasets
import MySQLdb
import math
from tempfile import TemporaryFile
from datetime import datetime
import operator
def task1(userid,model):
    # try:
    con = MySQLdb.connect(user='root', passwd='haha123', host='127.0.0.1', db="mwdb")
    users=queryexecutioner.queryActioner(con,'select distinct(userid) from mlusers')
    movies=queryexecutioner.queryActioner(con,'select distinct(movieid) from mlmovies')
    totaltags = queryexecutioner.queryActioner(con, 'select tagid from genome')
    recentTag = queryexecutioner.queryActioner(con, 'select timst from mltags order by timst desc')[0]#the most recent tag from database
    oldTag = queryexecutioner.queryActioner(con, 'select timst from mltags order by timst asc')[0]#the oldest tag from database
# converting to milliseconds
    recentTag = int(datetime.strptime(str(recentTag[0]), '%Y-%m-%d %H:%M:%S').strftime('%s'))
    oldTag = int(datetime.strptime(str(oldTag[0]), '%Y-%m-%d %H:%M:%S').strftime('%s'))
    user_tag_matrix=numpy.zeros([len(users),len(totaltags)])
    noOfUsers=len(users)
    # for user in users:
    #     actualResult = {}
    #     userVectortf = {}
    #     userVectoridf={}
    #     tags = queryexecutioner.queryActioner(con, 'select * from mltags where userid= '+str(user[0]))
    #     totalcount=0
    #     # this block calculates tf for all the tags and maintains it in dictionary actorVector
    #     for tag in tags:
    #         if(tag[2] in actualResult):
    #             actualResult[tag[2]]=(actualResult[tag[2]][0]+1,actualResult[tag[2]][1]+(float(int(datetime.strptime(str(tag[3]),'%Y-%m-%d %H:%M:%S').strftime('%s')))-oldTag)/(recentTag-oldTag))
    #             totalcount+=1
    #         else:
    #             actualResult[tag[2]]=(1,float((int(datetime.strptime(str(tag[3]),'%Y-%m-%d %H:%M:%S').strftime('%s')))-oldTag)/(recentTag-oldTag))
    #             totalcount+=1
    # # this block calculates the idf for all the tags and multiplies with tf 
    #     for tag in actualResult.keys():
    #         usersForTags = len(queryexecutioner.queryActioner(con, 'select distinct(userid) from mltags where tagid=' + str(tag)))
    #         idf=math.log(noOfUsers/usersForTags)
    #         user_tag_matrix[users.index((user[0],))][totaltags.index((tag,))] = (float(actualResult[tag][0])/totalcount)*actualResult[tag][1]*idf
    # final sorting according to score
    # numpy.save('/tmp/saved_matrices',user_tag_matrix)
    user_tag_matrix=numpy.load('/tmp/saved_matrices.npy')
    if model==0:
        mean_x=user_tag_matrix.mean(0)
        resultant_matrix=user_tag_matrix-mean_x
        U, s, V = numpy.linalg.svd(resultant_matrix, full_matrices=False)
        sample=U[:,0:4]
        sample1=numpy.diag(s[0:4]).reshape(4,4)
        z=numpy.matmul(sample,sample1)
        sim_matrix=similarity_calculation(userid,users,z)
        user_to_movie_matrix=find_score_for_movies(con,userid,users,movies,sim_matrix)
        # print user_to_movie_matrix



def similarity_calculation(userid,users,matrix):
    matrixTranspose=numpy.transpose(matrix)
    x=numpy.matmul(matrix[users.index((userid,))],matrixTranspose)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
    return x

def find_score_for_movies(con,userid,users,movies,sim_matrix):
    user_movie_score=numpy.zeros([1,len(movies)])
    for movie in movies:
        sum_all_users=0
        normalize_sum=0
        for user in users:
            # print user[0]
            # print movie[0]
            rating=queryexecutioner.queryActioner(con,'select rating from mlratings where userid= '+str(user[0])+' and movieid= '+str(movie[0]))
            # print rating
            if len(rating) is not 0:
                sum_all_users+=sim_matrix[users.index((user[0],))]*rating[0][0]
                normalize_sum+=sim_matrix[users.index((user[0],))]
        if sum_all_users is not 0:
            user_movie_score[0][movies.index((movie[0],))]=float(sum_all_users)/normalize_sum
    return user_movie_score

        # # print movies
        # # print len(users)
        # user_movie_rating=numpy.zeros([len(users),len(movies)])
        # movieid_rating_userid=queryexecutioner.queryActioner(con,'select movieid,rating,userid from mlratings')
        # for key,tuples in enumerate(movieid_rating_userid):
        #     print key
        #     user_movie_rating[users.index((tuples[2],))][movies.index((tuples[0],))]=tuples[1]
        # outfile=TemporaryFile()
        # numpy.save('/tmp/saved_matrices',user_movie_rating)
        # x=numpy.load('/tmp/saved_matrices.npy')
        # if model==0:
        #     mean_x=x.mean(0)
        #     resultant_matrix=x-mean_x
        #     U, s, V = numpy.linalg.svd(resultant_matrix, full_matrices=False)
        #     sample=U[users.index((userid,))][0:4]
        #     sample.reshape(1,4)
        #     sample1=numpy.diag(s[0:4]).reshape(4,4)
        #     z=numpy.matmul(sample,sample1)
        #     result=numpy.matmul(z,V[0:4][:])
        #     # print (U[users.index((userid,))]).shape
        #     result1=numpy.argsort(result)[::-1]
        #     finalMovies=[]
        #     print 'the movies watched by the user are '
        #     print '-----------------------------------'
        #     movies_list=queryexecutioner.queryActioner(con,'select movieid,rating from mlratings where userid= '+str(userid))
        #     movies_rated=[]
        #     for j in movies_list:
        #         movies_rated.append((queryexecutioner.queryActioner(con,'select moviename from mlmovies where movieid= '+str(j[0])),j[1]))
        #     print movies_rated
        #     print 'Recommendation of movies for this user'
        #     print '---------------------------------------'
        #     i=0
        #     while len(finalMovies)<6:
        #         check_if_present=queryexecutioner.queryActioner(con,'select movieid from mlratings where movieid=' + str(movies[result1[i]][0])+' and userid= '+str(userid))
        #         if(len(check_if_present)==0):
        #             moviename=queryexecutioner.queryActioner(con,'select moviename from mlmovies where movieid= '+str(movies[result1[i]][0]))
        #             finalMovies.append(moviename)
        #         i+=1
        #     print finalMovies
        # if model==1:
        #     mean_x=x.mean(0)
        #     dataAdjusted=x-mean_x
        #     resultant_matrix=numpy.cov(dataAdjusted, rowvar=False)#rowvar being false represents rows being observations and columns being variables/dimensions.
        #     U, s, V = numpy.linalg.svd(resultant_matrix, full_matrices=False)
        #     featureVector=U[:,0:4]
        #     featureVectorTransposed=numpy.transpose(featureVector)
        #     dataAdjustedTranspose=numpy.transpose(dataAdjusted)
        #     projectedMatrix=numpy.matmul(featureVectorTransposed,dataAdjustedTranspose)
        #     print projectedMatrix.shape
        #     # sample=U[users.index((userid,))][0:4]
        #     # sample.reshape(1,4)
        #     # sample1=numpy.diag(s[0:4]).reshape(4,4)
        #     # z=numpy.matmul(sample,sample1)
        #     # result=numpy.matmul(z,V[0:4][:])
        #     # # print (U[users.index((userid,))]).shape
        #     # result1=numpy.argsort(result)[::-1]
        #     # finalMovies=[]
        #     # print 'the movies watched by the user are '
        #     # print '-----------------------------------'
        #     # movies_list=queryexecutioner.queryActioner(con,'select movieid,rating from mlratings where userid= '+str(userid))
        #     # movies_rated=[]
        #     # for j in movies_list:
        #     #     movies_rated.append((queryexecutioner.queryActioner(con,'select moviename from mlmovies where movieid= '+str(j[0])),j[1]))
        #     # print movies_rated
        #     # print 'Recommendation of movies for this user'
        #     # print '---------------------------------------'
        #     # i=0
        #     # while len(finalMovies)<6:
        #     #     check_if_present=queryexecutioner.queryActioner(con,'select movieid from mlratings where movieid=' + str(movies[result1[i]][0])+' and userid= '+str(userid))
        #     #     if(len(check_if_present)==0):
        #     #         moviename=queryexecutioner.queryActioner(con,'select moviename from mlmovies where movieid= '+str(movies[result1[i]][0]))
        #     #         finalMovies.append(moviename)
        #     #     i+=1
        #     # print finalMovies

            
    # except Exception as e:
    #     print e
task1(481,0)